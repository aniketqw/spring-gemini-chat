name: Deploy to Hugging Face Space (Docker)

on:
  push:
    branches: [ master ]      # your repo's default branch
  workflow_dispatch:

jobs:
  build:
    name: Maven build (sanity)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-
      - name: Build (skip tests)
        run: mvn -B -DskipTests package

  sync-to-space:
        name: Push repo to Hugging Face Space
        needs: build
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4
            with:
              fetch-depth: 0
              lfs: true

          - name: Configure Git user
            run: |
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"

          - name: Push to Space (force on first sync)
            env:
              HF_TOKEN: ${{ secrets.HF_TOKEN }}            # write token from HF settings
              HF_USERNAME: Phoenix21                       # or keep using your GitHub variable
              HF_SPACE: SpringGeminiChat                   # or keep using your GitHub variable
            run: |
              set -e
              SPACE_PATH="${HF_USERNAME}/${HF_SPACE}"
    
              # add Space as a remote using token auth
              git lfs install --skip-repo
              git remote remove space 2>/dev/null || true
              git remote add space "https://${HF_USERNAME}:${HF_TOKEN}@huggingface.co/spaces/${SPACE_PATH}"
    
              # try a regular push first
              set +e
              git push space HEAD:main
              rc=$?
              set -e
              if [ $rc -ne 0 ]; then
                echo "Non-fast-forward detected; forcing initial sync to Space main."
                # safer than --force; refuses if remote moved unexpectedly during the run
                git push --force-with-lease space HEAD:main
              fi
